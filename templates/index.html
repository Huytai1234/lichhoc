<!DOCTYPE html>
<html>
<head>
    <title>UEL Calendar Sync Backend</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .status { margin-top: 15px; padding: 10px; border-radius: 5px; }
        .logged-in { background-color: #e7f4e4; border: 1px solid #4CAF50; color: #3c763d; }
        .logged-out { background-color: #f2dede; border: 1px solid #ebccd1; color: #a94442; }
        a { color: #337ab7; }
    </style>
</head>
<body>
    <h1>UEL Calendar Sync Backend</h1>
    <p>Server backend này đang chạy để hỗ trợ Chrome Extension đồng bộ TKB.</p>
    <p>Vui lòng sử dụng Chrome Extension để bắt đầu đồng bộ sau khi đã điều hướng đến trang TKB trên MyUEL.</p>

    {% if google_logged_in %}
        <div class="status logged-in">
            Trạng thái: Đã liên kết với tài khoản Google Calendar của <strong>{{ user_id }}</strong>.
            <form id="logoutForm" style="display: inline; margin-left: 10px;">
                 <button type="button" onclick="logoutGoogle()">Đăng xuất Google</button>
            </form>
             <span id="logoutStatus"></span>
        </div>
    {% else %}
        <div class="status logged-out">
            Trạng thái: Chưa liên kết với Google Calendar hoặc cần xác thực lại.
            <p>Nếu extension yêu cầu, hãy nhấn nút đồng bộ trên extension, một tab xác thực Google sẽ mở ra. Hoặc bạn có thể thử bắt đầu xác thực tại đây:</p>
            <input type="email" id="authUserId" placeholder="Nhập email @st.uel.edu.vn để xác thực" size="40">
            <button type="button" onclick="initiateAuth()">Bắt đầu liên kết Google Calendar</button>
             <span id="authStatus"></span>
        </div>

    {% endif %}

    <script>
        async function initiateAuth() {
            const userId = document.getElementById('authUserId').value.trim();
            const statusEl = document.getElementById('authStatus');
            if (!userId || !userId.includes('@st.uel.edu.vn')) {
                 statusEl.textContent = ' Vui lòng nhập đúng email sinh viên UEL.';
                 statusEl.style.color = 'red';
                return;
            }
             statusEl.textContent = ' Đang lấy URL xác thực...';
             statusEl.style.color = 'blue';
            try {
                const response = await fetch(`/initiate_auth?user_id=${encodeURIComponent(userId)}`);
                const data = await response.json();
                if (response.ok && data.auth_url) {
                     statusEl.textContent = ' Đang mở trang xác thực Google...';
                     window.open(data.auth_url, '_blank'); // Mở trong tab mới
                } else {
                    throw new Error(data.error || 'Không nhận được URL xác thực.');
                }
            } catch (error) {
                 statusEl.textContent = ` Lỗi: ${error.message}`;
                 statusEl.style.color = 'red';
            }
        }

         async function logoutGoogle() {
             const userId = "{{ user_id or '' }}"; // Lấy user_id từ template nếu có
             const statusEl = document.getElementById('logoutStatus');
             if (!userId) {
                  statusEl.textContent = ' Lỗi: Không tìm thấy User ID để đăng xuất.';
                  statusEl.style.color = 'red';
                  return; // Hoặc cố lấy từ input nếu có trường nhập trên trang
             }
             statusEl.textContent = ' Đang đăng xuất...';
             statusEl.style.color = 'blue';
             try {
                  const response = await fetch('/logout', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ user_id: userId }) // Gửi user_id nếu cần
                  });
                 const data = await response.json();
                 if (response.ok) {
                      statusEl.textContent = ` ${data.message}. Vui lòng tải lại trang.`;
                      statusEl.style.color = 'green';
                      // Có thể tự động tải lại trang: location.reload();
                 } else {
                     throw new Error(data.error || 'Lỗi không xác định.');
                 }
             } catch (error) {
                  statusEl.textContent = ` Lỗi: ${error.message}`;
                  statusEl.style.color = 'red';
             }
         }
    </script>

</body>
</html>
